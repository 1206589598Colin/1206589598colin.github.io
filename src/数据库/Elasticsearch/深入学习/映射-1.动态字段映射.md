# 动态字段映射

当 Elasticsearch 检测到文档中的新字段时，默认情况下它会动态地将该字段添加到类型映射中。动态参数控制这种行为。

通过将动态参数设置为 true 或 runtime，可以明确指示 Elasticsearch 根据传入文档动态创建字段。当启用动态字段映射时，Elasticsearch 使用下表中的规则来确定如何映射每个字段的数据类型。

下表中的字段数据类型是 Elasticsearch 动态检测的唯一字段数据类型。必须显式地映射所有其他数据类型。

[](https://www.elastic.co/guide/en/elasticsearch/reference/7.11/dynamic-field-mapping.html#dynamic-field-mapping-types)

| **JSON data type** | **`"dynamic":"true"`** | **`"dynamic":"runtime"`** |
| :-- |  :-- |  :-- |
| `null` | 没有添加字段 | 没有添加字段 |
| `true` or `false` | `boolean` | `boolean` |
| `double` | `float` | `double` |
| `integer` | `long` | `long` |
| `object`^1^ | `object` | `object` |
| `array` | 取决于数组中的第一个非null | 取决于数组中的第一个非null |
| `string` that passes [date detection](https://www.elastic.co/guide/en/elasticsearch/reference/7.11/dynamic-field-mapping.html#date-detection "Date detection") | `date` | `date` |
| `string` that passes [numeric detection](https://www.elastic.co/guide/en/elasticsearch/reference/7.11/dynamic-field-mapping.html#numeric-detection "Numeric detection") | `float` or `long` | `double` or `long` |
| `string` that doesn't pass `date` detection or `numeric` detection | `text` with a `.keyword` sub-field | `keyword` |

您可以在文档和对象级别禁用动态映射。将动态参数设置为 false 将忽略新字段，如果 Elasticsearch 遇到未知字段，将严格拒绝文档。

使用 PUT 映射 API 更新现有字段的动态设置。

您可以自定义用于日期检测和数字检测的动态字段映射规则。若要定义可应用于其他动态字段的自定义映射规则，请使用 dynamic_templates。

### 日期检测

如果启用了 date_detection (默认) ，那么将检查新的字符串字段，以查看它们的内容是否匹配在 dynamic_date_formats 中指定的任何日期模式。如果找到匹配项，则添加具有相应格式的新日期字段。

动态 date_formats 的默认值是:

["strict_date_optional_time"，" yyyy/MM/dd HH:MM:ss Z | yyyy/MM/dd Z"]

例如:

```
PUT my-index-000001/_doc/1
{
  "create_date": "2015/09/02"
}

GET my-index-000001/_mapping
```
create_date 字段作为日期字段添加，格式为: "yyyy/MM/dd HH:MM:ss Z | yyyy/MM/dd Z"。

### 禁用日期检测

可以通过将 date_detection 设置为 false 来禁用动态日期检测:

```
PUT my-index-000001
{
  "mappings": {
    "date_detection": false
  }
}

PUT my-index-000001/_doc/1 
{
  "create": "2015/09/02"
}
```

```
create_date 字段已作为文本字段添加。
```

### 自定义检测到的日期格式

可以定制动态的 dynamic_date_formats 来支持你自己的日期格式:

```
PUT my-index-000001
{
  "mappings": {
    "dynamic_date_formats": ["MM/dd/yyyy"]
  }
}

PUT my-index-000001/_doc/1
{
  "create_date": "09/25/2015"
}
```

### 数字检测

虽然 JSON 支持本地浮点数和整数数据类型，但有些应用程序或语言有时可能将数字呈现为字符串。通常正确的解决方案是显式地映射这些字段，但是数字检测(默认情况下禁用)可以自动地做到这一点:

```
PUT my-index-000001
{
  "mappings": {
    "numeric_detection": true
  }
}

PUT my-index-000001/_doc/1
{
  "my_float":   "1.0", 
  "my_integer": "1" 
}
```

* my_float 字段作为 float 字段添加。
* my_integer 字段作为长字段添加。